<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WebSocket Chat</title>
  <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>

  <!-- Registration form container -->
  <div id="registerContainer">
    <h2>Register</h2>
    <input id="regUsername" placeholder="Username" />
    <input id="regEmail" placeholder="Email" />
    <input id="regPassword" type="password" placeholder="Password" />
    <button onclick="register()">Register</button>
  </div>

  <!-- Chat UI container (initially hidden) -->
  <div id="chatContainer" style="display: none;">
    <h1>Real-Time Chat</h1>
    <p id="currentRoom">Room: <span id="roomNameDisplay"></span></p>
    <div>
      <input id="roomInput" placeholder="Enter room to join" />
      <button onclick="switchRoom()">Switch Room</button>
    </div>
    <input id="messageInput" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
    <button onclick="logout()">Logout</button>
    <ul id="messages"></ul>
  </div>

  <script>
    const escapeHtml = (str) =>
      str.replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;");

    let socket;
    let roomId;
    let username;

    async function register() {
      const regUsername = document.getElementById("regUsername").value.trim();
      const regEmail = document.getElementById("regEmail").value.trim();
      const regPassword = document.getElementById("regPassword").value;

      if (!regUsername || !regEmail || !regPassword) {
        alert("All fields are required");
        return;
      }

      try {
        const res = await fetch("http://localhost:5001/api/user/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username: regUsername,
            email: regEmail,
            password: regPassword
          })
        });

        const data = await res.json();

        if (res.status === 201) {
          console.log("✅ Registered:", data.user);
          localStorage.setItem("token", data.user.token);
          localStorage.setItem("username", data.user.username);

          roomId = prompt("Enter room name to join");
          if (!roomId || roomId.trim() === "") {
            alert("Room name is required");
            location.reload();
          }
          roomId = roomId.trim();
          localStorage.setItem("roomId", roomId);

          username = data.user.username;
          showChatUI();
          initSocket();
        } else {
          alert(`Registration failed: ${data.error}`);
        }
      } catch (err) {
        console.error("❌ Registration error:", err);
        alert("Server error during registration");
      }
    }

    function showChatUI() {
      document.getElementById("registerContainer").style.display = "none";
      document.getElementById("chatContainer").style.display = "block";
      document.getElementById("roomNameDisplay").textContent = roomId;
      loadMessages();
    }

    function initSocket() {
      socket = io("http://localhost:5001");

      socket.on("connect", () => {
        console.log("🟢 Connected as", username);
        socket.emit("join", roomId);
      });

      socket.on("message", (msg) => {
        const li = document.createElement("li");
        const time = new Date(msg.created_at).toLocaleTimeString();
        li.innerHTML = `<strong>${escapeHtml(msg.username)}</strong> (${time}): ${escapeHtml(msg.message || msg.content)}`;
        document.getElementById("messages").appendChild(li);
      });
    }

    async function loadMessages() {
      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`/api/chat/rooms/${roomId}/messages`, {headers: {
        "Authorization": `Bearer ${token}`
      }
      });
        const messages = await res.json();
        messages.reverse().forEach((msg) => {
          const li = document.createElement("li");
          const time = new Date(msg.created_at).toLocaleTimeString();
          li.innerHTML = `<strong>${escapeHtml(msg.username)}</strong> (${time}): ${escapeHtml(msg.content)}`;
          document.getElementById("messages").appendChild(li);
        });
      } catch (err) {
        console.error("❌ Failed to load messages:", err);
      }
    }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      const msg = input.value.trim();
      if (!msg) return;

      socket.emit("message", {
        username,
        message: msg,
        roomId
      });

      input.value = "";
    }

    async function switchRoom() {
      const newRoom = document.getElementById("roomInput").value.trim();
      if (!newRoom || newRoom === roomId) return;

      socket.emit("leave", roomId);
      socket.emit("join", newRoom);
      roomId = newRoom;
      localStorage.setItem("roomId", roomId);
      document.getElementById("roomNameDisplay").textContent = roomId;

      document.getElementById("messages").innerHTML = "";
      await loadMessages();
    }

    function logout() {
      localStorage.clear();
      location.reload();
    }

    // Auto-login if already registered before
    window.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      username = localStorage.getItem("username");
      roomId = localStorage.getItem("roomId");

      if (token && username && roomId) {
        showChatUI();
        initSocket();
      }
    });
  </script>
</body>
</html>


